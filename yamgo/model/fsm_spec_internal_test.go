// Code generated by "fsm_spec_internal_test_generator.go"; DO NOT EDIT

package model_test

import "testing"
import "github.com/10gen/mongo-go-driver/bson"
import "github.com/10gen/mongo-go-driver/yamgo/connstring"
import "github.com/10gen/mongo-go-driver/yamgo/internal"
import . "github.com/10gen/mongo-go-driver/yamgo/model"

func TestFSM_Discover_arbiters(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Arbiters = []string{"b:27017"}
	imr.Hosts = []string{"a:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Discover_passives(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017"}
	imr.IsMaster = true
	imr.Passives = []string{"b:27017"}
	imr.SetName = "rs"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}

	// phase 2 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017"}
	imr.Passives = []string{"b:27017"}
	imr.Secondary = true
	imr.SetName = "rs"
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 2 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != RSSecondary {
		t.Fatalf("expected s.Kind to be RSSecondary, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Replica_set_discovery_from_primary(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Replica_set_discovery_from_secondary(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://b/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.Secondary = true
	imr.SetName = "rs"
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetNoPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != RSSecondary {
		t.Fatalf("expected s.Kind to be RSSecondary, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Replica_set_discovery(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017", "c:27017"}
	imr.Secondary = true
	imr.SetName = "rs"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetNoPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 3 {
		t.Fatalf("expected len(fsm.Servers) to be 3, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSSecondary {
		t.Fatalf("expected s.Kind to be RSSecondary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("c:27017"))
	if !ok {
		t.Fatalf("server c:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}

	// phase 2 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"b:27017", "c:27017", "d:27017"}
	imr.Secondary = true
	imr.SetName = "rs"
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 2 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetNoPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 4 {
		t.Fatalf("expected len(fsm.Servers) to be 4, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSSecondary {
		t.Fatalf("expected s.Kind to be RSSecondary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != RSSecondary {
		t.Fatalf("expected s.Kind to be RSSecondary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("c:27017"))
	if !ok {
		t.Fatalf("server c:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("d:27017"))
	if !ok {
		t.Fatalf("server d:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}

	// phase 3 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"b:27017", "c:27017", "d:27017", "e:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	s = BuildServer(Addr("d:27017"), imr, bir)
	fsm.Apply(s)

	// phase 3 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 4 {
		t.Fatalf("expected len(fsm.Servers) to be 4, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != RSSecondary {
		t.Fatalf("expected s.Kind to be RSSecondary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("c:27017"))
	if !ok {
		t.Fatalf("server c:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("d:27017"))
	if !ok {
		t.Fatalf("server d:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("e:27017"))
	if !ok {
		t.Fatalf("server e:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}

	// phase 4 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017", "c:27017"}
	imr.Secondary = true
	imr.SetName = "rs"
	s = BuildServer(Addr("c:27017"), imr, bir)
	fsm.Apply(s)

	// phase 4 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 4 {
		t.Fatalf("expected len(fsm.Servers) to be 4, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != RSSecondary {
		t.Fatalf("expected s.Kind to be RSSecondary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("c:27017"))
	if !ok {
		t.Fatalf("server c:27017 was not found")
	}
	if s.Kind != RSSecondary {
		t.Fatalf("expected s.Kind to be RSSecondary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("d:27017"))
	if !ok {
		t.Fatalf("server d:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("e:27017"))
	if !ok {
		t.Fatalf("server e:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
}

func TestFSM_New_primary_with_equal_electionId(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000001")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 - response 2
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000001")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Ghost_discovered(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a,b/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.IsReplicaSet = true
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetNoPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != RSGhost {
		t.Fatalf("expected s.Kind to be RSGhost, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Host_list_differs_from_seeds(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetNoPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Member_removed_by_reconfig(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a,b/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}

	// phase 2 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 2 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Member_brought_up_as_standalone(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a,b")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.IsMaster = true
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "" {
		t.Fatalf("expected fsm.SetName to be \"\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != Unknown {
		t.Fatalf("expected fsm.Kind to be Unknown, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}

	// phase 2 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 2 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
}

func TestFSM_New_primary(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a,b/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}

	// phase 2 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 2 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
}

func TestFSM_New_primary_with_greater_setVersion_and_electionId(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000001")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}

	// phase 2 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000002")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 2 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}

	// phase 3 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000001")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 3 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
}

func TestFSM_New_primary_with_greater_setVersion(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000001")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}

	// phase 2 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000001")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 2
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 2 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}

	// phase 3 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000001")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 3 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
}

func TestFSM_New_primary_with_wrong_setName(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}

	// phase 2 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017"}
	imr.IsMaster = true
	imr.SetName = "wrong"
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 2 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Non_replicaSet_member_responds(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a,b/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetNoPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Replica_set_case_normalization(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://A/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Arbiters = []string{"C:27017"}
	imr.Hosts = []string{"A:27017"}
	imr.IsMaster = true
	imr.Passives = []string{"B:27017"}
	imr.SetName = "rs"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 3 {
		t.Fatalf("expected len(fsm.Servers) to be 3, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("c:27017"))
	if !ok {
		t.Fatalf("server c:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Primaries_with_and_without_electionIds(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017", "c:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 3 {
		t.Fatalf("expected len(fsm.Servers) to be 3, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("c:27017"))
	if !ok {
		t.Fatalf("server c:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}

	// phase 2 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000002")
	imr.Hosts = []string{"a:27017", "b:27017", "c:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 2 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 3 {
		t.Fatalf("expected len(fsm.Servers) to be 3, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("c:27017"))
	if !ok {
		t.Fatalf("server c:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}

	// phase 3 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017", "c:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 3 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 3 {
		t.Fatalf("expected len(fsm.Servers) to be 3, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("c:27017"))
	if !ok {
		t.Fatalf("server c:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}

	// phase 4 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000001")
	imr.Hosts = []string{"a:27017", "b:27017", "c:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	s = BuildServer(Addr("c:27017"), imr, bir)
	fsm.Apply(s)

	// phase 4 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 3 {
		t.Fatalf("expected len(fsm.Servers) to be 3, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("c:27017"))
	if !ok {
		t.Fatalf("server c:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Primary_becomes_standalone(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}

	// phase 2 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 2 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetNoPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 0 {
		t.Fatalf("expected len(fsm.Servers) to be 0, but got \"%v\"", len(fsm.Servers))
	}
}

func TestFSM_Primary_changes_setName(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}

	// phase 2 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017"}
	imr.IsMaster = true
	imr.SetName = "wrong"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 2 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetNoPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 0 {
		t.Fatalf("expected len(fsm.Servers) to be 0, but got \"%v\"", len(fsm.Servers))
	}
}

func TestFSM_Disconnected_from_primary(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}

	// phase 2 - response 1
	imr = &internal.IsMasterResult{}
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 2 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetNoPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Disconnected_from_primary__reject_primary_with_stale_electionId(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000001")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 - response 2
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000002")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}

	// phase 2 - response 1
	imr = &internal.IsMasterResult{}
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 2 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetNoPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}

	// phase 3 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000001")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 3 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetNoPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}

	// phase 4 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000003")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 4 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}

	// phase 5 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.Secondary = true
	imr.SetName = "rs"
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 5 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != RSSecondary {
		t.Fatalf("expected s.Kind to be RSSecondary, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Disconnected_from_primary__reject_primary_with_stale_setVersion(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000001")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 - response 2
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000001")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 2
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}

	// phase 2 - response 1
	imr = &internal.IsMasterResult{}
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 2 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetNoPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}

	// phase 3 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000001")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 3 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetNoPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}

	// phase 4 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000002")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 2
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 4 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}

	// phase 5 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.Secondary = true
	imr.SetName = "rs"
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 5 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != RSSecondary {
		t.Fatalf("expected s.Kind to be RSSecondary, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Secondary_with_mismatched__me__tells_us_who_the_primary_is(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"b:27017"}
	imr.Me = "c:27017"
	imr.Secondary = true
	imr.SetName = "rs"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetNoPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}

	// phase 2 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"b:27017"}
	imr.IsMaster = true
	imr.Me = "b:27017"
	imr.SetName = "rs"
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 2 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Primary_mismatched_me(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://localhost:27017/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.Me = "a:27017"
	imr.SetName = "rs"
	s = BuildServer(Addr("localhost:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetNoPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Primary_reports_a_new_member(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.Secondary = true
	imr.SetName = "rs"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetNoPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSSecondary {
		t.Fatalf("expected s.Kind to be RSSecondary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}

	// phase 2 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 2 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSSecondary {
		t.Fatalf("expected s.Kind to be RSSecondary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}

	// phase 3 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017", "c:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 3 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 3 {
		t.Fatalf("expected len(fsm.Servers) to be 3, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSSecondary {
		t.Fatalf("expected s.Kind to be RSSecondary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("c:27017"))
	if !ok {
		t.Fatalf("server c:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}

	// phase 4 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017", "c:27017"}
	imr.Secondary = true
	imr.SetName = "rs"
	s = BuildServer(Addr("c:27017"), imr, bir)
	fsm.Apply(s)

	// phase 4 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 3 {
		t.Fatalf("expected len(fsm.Servers) to be 3, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSSecondary {
		t.Fatalf("expected s.Kind to be RSSecondary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("c:27017"))
	if !ok {
		t.Fatalf("server c:27017 was not found")
	}
	if s.Kind != RSSecondary {
		t.Fatalf("expected s.Kind to be RSSecondary, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Primary_to_no_primary_with_mismatched_me(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.Me = "a:27017"
	imr.SetName = "rs"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}

	// phase 2 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"c:27017", "d:27017"}
	imr.IsMaster = true
	imr.Me = "c:27017"
	imr.SetName = "rs"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 2 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetNoPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("c:27017"))
	if !ok {
		t.Fatalf("server c:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("d:27017"))
	if !ok {
		t.Fatalf("server d:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Primary_wrong_setName(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017"}
	imr.IsMaster = true
	imr.SetName = "wrong"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetNoPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 0 {
		t.Fatalf("expected len(fsm.Servers) to be 0, but got \"%v\"", len(fsm.Servers))
	}
}

func TestFSM_Response_from_removed_server(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a,b/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}

	// phase 2 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.Secondary = true
	imr.SetName = "rs"
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 2 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
}

func TestFSM_RSOther_discovered(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a,b/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hidden = true
	imr.Hosts = []string{"c:27017", "d:27017"}
	imr.Secondary = true
	imr.SetName = "rs"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 - response 2
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"c:27017", "d:27017"}
	imr.SetName = "rs"
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetNoPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 4 {
		t.Fatalf("expected len(fsm.Servers) to be 4, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSMember {
		t.Fatalf("expected s.Kind to be RSMember, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != RSMember {
		t.Fatalf("expected s.Kind to be RSMember, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("c:27017"))
	if !ok {
		t.Fatalf("server c:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("d:27017"))
	if !ok {
		t.Fatalf("server d:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Secondary_s_host_list_is_not_authoritative(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 - response 2
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"b:27017", "c:27017"}
	imr.Secondary = true
	imr.SetName = "rs"
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != RSSecondary {
		t.Fatalf("expected s.Kind to be RSSecondary, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Secondary_mismatched_me(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://localhost:27017/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.Me = "a:27017"
	imr.SetName = "rs"
	s = BuildServer(Addr("localhost:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetNoPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Secondary_wrong_setName(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017"}
	imr.Secondary = true
	imr.SetName = "wrong"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetNoPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 0 {
		t.Fatalf("expected len(fsm.Servers) to be 0, but got \"%v\"", len(fsm.Servers))
	}
}

func TestFSM_Secondary_wrong_setName_with_primary(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a,b/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}

	// phase 2 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.Secondary = true
	imr.SetName = "wrong"
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 2 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
}

func TestFSM_setVersion_is_ignored_if_there_is_no_electionId(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 2
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}

	// phase 2 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 2 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Primary_becomes_a_secondary_with_wrong_setName(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}

	// phase 2 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017"}
	imr.Secondary = true
	imr.SetName = "wrong"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 2 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetNoPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 0 {
		t.Fatalf("expected len(fsm.Servers) to be 0, but got \"%v\"", len(fsm.Servers))
	}
}

func TestFSM_Unexpected_mongos(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://b/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.IsMaster = true
	imr.Msg = "isdbgrid"
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetNoPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 0 {
		t.Fatalf("expected len(fsm.Servers) to be 0, but got \"%v\"", len(fsm.Servers))
	}
}

func TestFSM_Record_max_setVersion__even_from_primary_without_electionId(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000001")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}

	// phase 2 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 2
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 2 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}

	// phase 3 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.ElectionID = bson.ObjectIdHex("000000000000000000000002")
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	imr.SetVersion = 1
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 3 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetWithPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetWithPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Wrong_setName(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a,b/?replicaSet=rs")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"b:27017", "c:27017"}
	imr.Secondary = true
	imr.SetName = "wrong"
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "rs" {
		t.Fatalf("expected fsm.SetName to be \"rs\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != ReplicaSetNoPrimary {
		t.Fatalf("expected fsm.Kind to be ReplicaSetNoPrimary, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Mongos_disconnect(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a,b")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.IsMaster = true
	imr.Msg = "isdbgrid"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 - response 2
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.IsMaster = true
	imr.Msg = "isdbgrid"
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "" {
		t.Fatalf("expected fsm.SetName to be \"\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != Sharded {
		t.Fatalf("expected fsm.Kind to be Sharded, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Mongos {
		t.Fatalf("expected s.Kind to be Mongos, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Mongos {
		t.Fatalf("expected s.Kind to be Mongos, but got \"%v\"", s.Kind)
	}

	// phase 2 - response 1
	imr = &internal.IsMasterResult{}
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 2 outcome
	if fsm.SetName != "" {
		t.Fatalf("expected fsm.SetName to be \"\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != Sharded {
		t.Fatalf("expected fsm.Kind to be Sharded, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Mongos {
		t.Fatalf("expected s.Kind to be Mongos, but got \"%v\"", s.Kind)
	}

	// phase 3 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.IsMaster = true
	imr.Msg = "isdbgrid"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 3 outcome
	if fsm.SetName != "" {
		t.Fatalf("expected fsm.SetName to be \"\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != Sharded {
		t.Fatalf("expected fsm.Kind to be Sharded, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Mongos {
		t.Fatalf("expected s.Kind to be Mongos, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Mongos {
		t.Fatalf("expected s.Kind to be Mongos, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Multiple_mongoses(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a,b")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.IsMaster = true
	imr.Msg = "isdbgrid"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 - response 2
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.IsMaster = true
	imr.Msg = "isdbgrid"
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "" {
		t.Fatalf("expected fsm.SetName to be \"\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != Sharded {
		t.Fatalf("expected fsm.Kind to be Sharded, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Mongos {
		t.Fatalf("expected s.Kind to be Mongos, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Mongos {
		t.Fatalf("expected s.Kind to be Mongos, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Non_Mongos_server_in_sharded_cluster(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a,b")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.IsMaster = true
	imr.Msg = "isdbgrid"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 - response 2
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	s = BuildServer(Addr("b:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "" {
		t.Fatalf("expected fsm.SetName to be \"\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != Sharded {
		t.Fatalf("expected fsm.Kind to be Sharded, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Mongos {
		t.Fatalf("expected s.Kind to be Mongos, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Normalize_URI_case(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://A,B")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	// phase 1 outcome
	if fsm.SetName != "" {
		t.Fatalf("expected fsm.SetName to be \"\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != Unknown {
		t.Fatalf("expected fsm.Kind to be Unknown, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 2 {
		t.Fatalf("expected len(fsm.Servers) to be 2, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	var s *Server
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Direct_connection_to_RSPrimary_via_external_IP(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "" {
		t.Fatalf("expected fsm.SetName to be \"\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != Single {
		t.Fatalf("expected fsm.Kind to be Single, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Connect_to_mongos(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.IsMaster = true
	imr.Msg = "isdbgrid"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "" {
		t.Fatalf("expected fsm.SetName to be \"\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != Single {
		t.Fatalf("expected fsm.Kind to be Single, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Mongos {
		t.Fatalf("expected s.Kind to be Mongos, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Connect_to_RSArbiter(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.ArbiterOnly = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.SetName = "rs"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "" {
		t.Fatalf("expected fsm.SetName to be \"\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != Single {
		t.Fatalf("expected fsm.Kind to be Single, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSArbiter {
		t.Fatalf("expected s.Kind to be RSArbiter, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Connect_to_RSPrimary(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.IsMaster = true
	imr.SetName = "rs"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "" {
		t.Fatalf("expected fsm.SetName to be \"\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != Single {
		t.Fatalf("expected fsm.Kind to be Single, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSPrimary {
		t.Fatalf("expected s.Kind to be RSPrimary, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Connect_to_RSSecondary(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.Hosts = []string{"a:27017", "b:27017"}
	imr.Secondary = true
	imr.SetName = "rs"
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "" {
		t.Fatalf("expected fsm.SetName to be \"\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != Single {
		t.Fatalf("expected fsm.Kind to be Single, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != RSSecondary {
		t.Fatalf("expected s.Kind to be RSSecondary, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Direct_connection_to_slave(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "" {
		t.Fatalf("expected fsm.SetName to be \"\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != Single {
		t.Fatalf("expected fsm.Kind to be Single, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Standalone {
		t.Fatalf("expected s.Kind to be Standalone, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Connect_to_standalone(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.IsMaster = true
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "" {
		t.Fatalf("expected fsm.SetName to be \"\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != Single {
		t.Fatalf("expected fsm.Kind to be Single, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Standalone {
		t.Fatalf("expected s.Kind to be Standalone, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Handle_a_not_ok_ismaster_response(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.IsMaster = true
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 - response 2
	imr = &internal.IsMasterResult{}
	imr.IsMaster = true
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "" {
		t.Fatalf("expected fsm.SetName to be \"\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != Single {
		t.Fatalf("expected fsm.Kind to be Single, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Standalone_removed_from_multi_server_topology(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a,b")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	imr.OK = true
	imr.IsMaster = true
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "" {
		t.Fatalf("expected fsm.SetName to be \"\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != Unknown {
		t.Fatalf("expected fsm.Kind to be Unknown, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("b:27017"))
	if !ok {
		t.Fatalf("server b:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
}

func TestFSM_Unavailable_seed(t *testing.T) {
	t.Parallel()

	fsm := NewFSM()

	cs, _ := connstring.Parse("mongodb://a")
	fsm.SetName = cs.ReplicaSet
	if fsm.SetName != "" {
		fsm.Kind = ReplicaSetNoPrimary
	}
	if len(cs.Hosts) == 1 && fsm.SetName == "" {
		fsm.Kind = Single
	}
	for _, host := range cs.Hosts {
		fsm.Servers = append(fsm.Servers, &Server{Addr: Addr(host).Canonicalize()})
	}

	var s *Server
	bir := &internal.BuildInfoResult{Version: "3.4.0", VersionArray: []uint8{3, 4, 0}}
	var imr *internal.IsMasterResult

	// phase 1 - response 1
	imr = &internal.IsMasterResult{}
	s = BuildServer(Addr("a:27017"), imr, bir)
	fsm.Apply(s)

	// phase 1 outcome
	if fsm.SetName != "" {
		t.Fatalf("expected fsm.SetName to be \"\", but got \"%v\"", fsm.SetName)
	}
	if fsm.Kind != Single {
		t.Fatalf("expected fsm.Kind to be Single, but got \"%v\"", fsm.Kind)
	}
	if len(fsm.Servers) != 1 {
		t.Fatalf("expected len(fsm.Servers) to be 1, but got \"%v\"", len(fsm.Servers))
	}

	var ok bool
	s, ok = fsm.Server(Addr("a:27017"))
	if !ok {
		t.Fatalf("server a:27017 was not found")
	}
	if s.Kind != Unknown {
		t.Fatalf("expected s.Kind to be Unknown, but got \"%v\"", s.Kind)
	}
}
